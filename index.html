  document.addEventListener('DOMContentLoaded', () => {
    // màn hình
    const screens = {
      start: document.getElementById('startScreen'),
      setup: document.getElementById('setupScreen'),
      view: document.getElementById('viewScreen'),
      quiz: document.getElementById('quizScreen'),
      result: document.getElementById('resultScreen'),
    };
    function show(name) {
      Object.values(screens).forEach(s => s.classList.add('hidden'));
      screens[name].classList.remove('hidden');
    }
    show('start');

    // controls
    const participantName = document.getElementById('participantName');
    const startBtn = document.getElementById('startBtn');
    const editBtn = document.getElementById('editBtn');
    const modeBtn = document.getElementById('modeBtn');
    const manualDiv = document.getElementById('manual');
    const bulkDiv = document.getElementById('bulk');
    const qInput = document.getElementById('qInput');
    const aInputs = [
      document.getElementById('a0'),
      document.getElementById('a1'),
      document.getElementById('a2'),
      document.getElementById('a3'),
    ];
    const correctSel = document.getElementById('correctSel');
    const addBtn = document.getElementById('addBtn');
    const bulkArea = document.getElementById('bulkArea');
    const importBtn = document.getElementById('importBtn');
    const countP = document.getElementById('count');
    const viewBtn = document.getElementById('viewBtn');
    const viewContainer = document.getElementById('viewContainer');
    const backBtn = document.getElementById('backBtn');
    const quizContainer = document.getElementById('quizContainer');
    const submitBtn = document.getElementById('submitBtn');
    const resultText = document.getElementById('resultText');
    const retryBtn = document.getElementById('retryBtn');
    const homeBtn = document.getElementById('homeBtn');

    let questions = [];
    let score = 0;

    function updateCount() {
      countP.textContent = `${questions.length} câu hỏi`;
    }
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // “Chỉnh sửa đề” -> show setup
    editBtn.addEventListener('click', () => {
      show('setup');
    });

    // chuyển giữa thủ công / nhanh
    modeBtn.addEventListener('click', () => {
      const manualHidden = manualDiv.classList.toggle('hidden');
      bulkDiv.classList.toggle('hidden', !manualHidden);
      modeBtn.textContent = manualHidden ? 'Nhập thủ công' : 'Nhập nhanh';
    });

    // thêm câu
    addBtn.addEventListener('click', () => {
      const q = qInput.value.trim();
      const opts = aInputs.map(i => i.value.trim());
      const ci = +correctSel.value;
      if (!q || opts.some(o => !o)) {
        alert('Nhập đầy đủ thông tin');
        return;
      }
      questions.push({ question: q, options: opts, correct: ci });
      qInput.value = '';
      aInputs.forEach(i => i.value = '');
      updateCount();
    });

    // import nhanh
    importBtn.addEventListener('click', () => {
      questions = [];
      bulkArea.value.split(/\n\s*\n/).forEach(block => {
        const lines = block.split(/\r?\n/).filter(l => l.trim());
        if (lines.length < 2) return;
        const q = lines[0].replace(/^Câu\s*\d+:\s*/, '').trim();
        let ci = 0;
        const opts = [];
        lines.slice(1).forEach(l => {
          const m = l.match(/^\*?([A-D])\.\s*(.+)$/);
          if (m) {
            const idx = m[1].charCodeAt(0) - 65;
            opts[idx] = m[2].trim();
            if (l.startsWith('*')) ci = idx;
          }
        });
        if (opts.length === 4) {
          questions.push({ question: q, options: opts, correct: ci });
        }
      });
      bulkArea.value = '';
      updateCount();
    });

    // “Đề hiện tại”
    viewBtn.addEventListener('click', () => {
      show('view');
      viewContainer.innerHTML = '';
      questions.forEach((q, i) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        const h2 = document.createElement('h2');
        h2.textContent = `Câu ${i + 1}: ${q.question}`;
        card.appendChild(h2);
        const act = document.createElement('div');
        act.className = 'actions';
        const edit = document.createElement('span');
        edit.textContent = '✎';
        edit.addEventListener('click', () => {
          show('setup');
          qInput.value = q.question;
          aInputs.forEach((ai, j) => ai.value = q.options[j]);
          correctSel.value = q.correct;
          questions.splice(i, 1);
          updateCount();
        });
        const del = document.createElement('span');
        del.textContent = '✖';
        del.addEventListener('click', () => {
          questions.splice(i, 1);
          viewBtn.click();
        });
        act.appendChild(edit);
        act.appendChild(del);
        card.appendChild(act);
        viewContainer.appendChild(card);
      });
    });
    backBtn.addEventListener('click', () => show('setup'));

    // “Bắt đầu”
    startBtn.addEventListener('click', () => {
      if (!participantName.value.trim()) {
        alert('Nhập tên của bạn');
        return;
      }
      if (!questions.length) {
        alert('Chưa có câu hỏi');
        return;
      }
      // xáo nếu cần
      //shuffleArray(questions);
      show('quiz');
      quizContainer.innerHTML = '';
      score = 0;
      questions.forEach((q, i) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        const h2 = document.createElement('h2');
        h2.textContent = `Câu ${i + 1}: ${q.question}`;
        card.appendChild(h2);
        const opts = document.createElement('div');
        opts.className = 'options';
        q.options.forEach((o, j) => {
          const btn = document.createElement('div');
          btn.className = 'option';
          btn.textContent = `${String.fromCharCode(65 + j)}. ${o}`;
          btn.addEventListener('click', () => {
            opts.querySelectorAll('.option').forEach(x => x.classList.remove('selected'));
            btn.classList.add('selected');
          });
          opts.appendChild(btn);
        });
        card.appendChild(opts);
        quizContainer.appendChild(card);
      });
    });

    // Nộp bài
    submitBtn.addEventListener('click', () => {
      const cards = quizContainer.querySelectorAll('.question-card');
      cards.forEach((c, i) => {
        const sel = c.querySelector('.option.selected');
        if (sel && sel.textContent.startsWith(String.fromCharCode(65 + questions[i].correct) + '.')) {
          score++;
        }
      });
      resultText.textContent = `${participantName.value}, bạn đúng ${score}/${questions.length} câu.`;
      show('result');
    });

    // Làm lại
    retryBtn.addEventListener('click', () => {
      show('quiz');
    });

    // Về trang chủ
    homeBtn.addEventListener('click', () => {
      show('start');
      questions = [];
      score = 0;
      participantName.value = '';
      updateCount();
    });
  });
                            </script>
