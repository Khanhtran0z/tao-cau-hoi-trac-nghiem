<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuizApp </title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --primary:#6366f1;
      --primary-dark:#4f46e5;
      --bg:#f1f5f9;
      --card:#ffffff;
      --txt:#0f172a;
      --muted:#64748b;
      --radius:16px;
      --shadow:0 6px 20px rgb(0 0 0/.08);
      --t:all .25s cubic-bezier(.4,0,.2,1);
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Inter",sans-serif;background:var(--bg);color:var(--txt)}
    #app{height:100%;display:flex;align-items:center;justify-content:center;padding:16px}
    .card{width:95vw;max-width:1000px;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden;position:relative}

    header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);padding:16px 18px;color:#fff;display:flex;align-items:center;gap:10px;position:relative}
    .title{display:flex;align-items:center;gap:8px;margin:0 auto;font-weight:800;letter-spacing:.2px}
    .chip{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.18);color:#fff;font-weight:700;font-size:.78rem}
    .iconbtn{width:42px;height:42px;border:none;border-radius:12px;background:rgba(255,255,255,.16);backdrop-filter:blur(4px);display:grid;place-items:center;font-size:20px;cursor:pointer;transition:var(--t);color:#fff}
    .iconbtn:hover{transform:translateY(-1px);background:rgba(255,255,255,.24)}

    .screen{padding:22px;overflow:auto;flex:1;animation:fadeSlide .35s}
    .hidden{display:none!important}

    input,textarea,select{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:14px;font-size:1rem;margin:8px 0;transition:var(--t);background:#fff}
    textarea{min-height:110px}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgb(99 102 241/.22)}
    label{font-weight:700}

    .btn{background:var(--primary);color:#fff;border:none;border-radius:14px;padding:12px 18px;font-weight:700;cursor:pointer;transition:var(--t);box-shadow:0 2px 6px rgb(0 0 0/.1)}
    .btn:hover{background:var(--primary-dark);transform:translateY(-1px)}
    .btn.secondary{background:#e2e8f0;color:#0f172a}
    .btn.ghost{background:transparent;color:#0f172a;border:2px solid #e2e8f0}

    .qcard{background:#fff;border:2px solid transparent;border-radius:16px;padding:18px;margin-bottom:16px;box-shadow:var(--shadow);position:relative;transition:var(--t)}
    .qcard:hover{border-color:var(--primary);transform:translateY(-2px)}
    .qcard h3{margin:0 0 12px;font-size:1.05rem;font-weight:800}

    .actions{position:absolute;top:10px;right:12px;display:flex;gap:10px;font-size:18px;color:var(--muted)}
    .actions span{cursor:pointer;transition:var(--t)}
    .actions span:hover{color:var(--primary);transform:scale(1.15)}

    .optwrap{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .opt{border:2px solid var(--primary);border-radius:12px;padding:10px 12px;background:#f8fafc;cursor:pointer;transition:var(--t);user-select:none}
    .opt.selected{background:var(--primary);color:#fff;transform:scale(1.02)}

    .correct{outline:2px solid #16a34a;animation:pop .35s}
    .wrong{outline:2px solid #ef4444;animation:shake .35s}

    /* progress + timer bar */
    .topbar{display:flex;align-items:center;gap:12px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:14px;padding:8px 12px;margin-bottom:12px}
    .progress{height:8px;background:#e2e8f0;border-radius:999px;overflow:hidden;flex:1}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-dark));width:0%;transition:width .35s ease}
    .timer{font-weight:800;min-width:90px;text-align:right}

    /* login modal */
    #login{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:40}
    #login.show{display:flex}
    #loginBox{background:#fff;padding:26px;border-radius:16px;width:90%;max-width:420px;box-shadow:var(--shadow);position:relative}
    #closeLogin{position:absolute;top:8px;right:10px;font-size:20px;color:#64748b;cursor:pointer;transition:var(--t)}
    #closeLogin:hover{color:var(--primary);transform:scale(1.1)}

    /* tips modal */
    #tips{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:35}
    #tips.show{display:flex}
    .modal-card{background:#fff;padding:20px;border-radius:16px;width:min(700px,92vw);box-shadow:var(--shadow)}

    /* image preview */
    #imgPreview{max-width:100%;max-height:150px;margin-top:6px;border-radius:12px}
    .remove-img{margin-left:8px;cursor:pointer;color:#e11d48;background:none;border:none;font-size:14px}

    @keyframes fadeSlide{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
    @keyframes pop{0%{transform:scale(.98)}100%{transform:scale(1)}}
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-3px)}40%,60%{transform:translateX(3px)}}

    @media(max-width:700px){ .optwrap{grid-template-columns:1fr} .title{margin:0} }
  </style>
</head>
<body>
<div id="app">
  <div id="card" class="card">
    <header>
      <button id="tipsBtn" class="iconbtn" title="Kinh nghi·ªám">‚ùì</button>
      <h1 class="title">QuizApp <span class="chip"> Kh√°nh Tr·∫ßn</span></h1>
      <button id="gear" class="iconbtn" title="C√†i ƒë·∫∑t">‚öôÔ∏è</button>
      <button id="userBtn" class="iconbtn" title="Nh·∫≠p t√™n">üë§</button>
    </header>

    <!-- LOGIN -->
    <div id="login">
      <div id="loginBox">
        <span id="closeLogin">‚úñ</span>
        <h2 style="margin:0 0 10px">Nh·∫≠p t√™n ng∆∞·ªùi l√†m b√†i</h2>
        <p style="margin:0 0 10px;color:var(--muted)">T√™n s·∫Ω hi·ªÉn th·ªã trong k·∫øt qu·∫£ v√† b·∫£ng level</p>
        <input id="nameInp" placeholder="T√™n c·ªßa b·∫°n" spellcheck>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button id="startBtn" class="btn" type="button">B·∫Øt ƒë·∫ßu</button>
        </div>
      </div>
    </div>

    <!-- TIPS -->
    <div id="tips">
      <div class="modal-card">
        <h3 style="margin:0 0 8px">Kinh nghi·ªám l√†m b√†i hi·ªáu qu·∫£</h3>
        <ul style="margin:6px 0 12px;color:var(--muted)">
          <li>T·ª± lu·∫≠n: vi·∫øt theo c·∫•u tr√∫c <strong>M·ªü ‚Äì Th√¢n ‚Äì K·∫øt</strong>, ch√®n <strong>t·ª´ kho√°</strong> ƒë√£ cho.</li>
          <li>D√πng v√≠ d·ª•/c√¥ng th·ª©c ng·∫Øn ƒë·ªÉ tƒÉng ƒëi·ªÉm t∆∞∆°ng ƒë·ªìng v·ªõi ƒë√°p √°n m·∫´u.</li>
          <li>Qu·∫£n l√Ω th·ªùi gian: ph√¢n b·ªï ƒë·ªÅu, ƒë·ª´ng b·ªè tr·ªëng c√¢u. H·∫øt gi·ªù s·∫Ω t·ª± n·ªôp b√†i.</li>
        </ul>
        <div style="display:flex;justify-content:flex-end"><button id="closeTips" class="btn" type="button">ƒê√£ hi·ªÉu</button></div>
      </div>
    </div>

    <!-- SETTINGS DROPDOWN -->
    <div id="settings" class="hidden" style="position:absolute;top:70px;right:12px;background:#fff;border:2px solid #e2e8f0;border-radius:16px;box-shadow:var(--shadow);padding:14px;width:280px;z-index:30">
      <div style="font-weight:800;margin-bottom:6px">C√†i ƒë·∫∑t</div>
      <button id="toggleSQ" class="btn secondary" type="button" style="width:100%;margin-top:6px">X√°o c√¢u h·ªèi: B·∫≠t</button>
      <button id="toggleSA" class="btn secondary" type="button" style="width:100%;margin-top:6px">X√°o ƒë√°p √°n: B·∫≠t</button>
      <button id="toggleSpell" class="btn secondary" type="button" style="width:100%;margin-top:6px">Spellcheck: B·∫≠t</button>
      <button id="fsBtn" class="btn secondary" type="button" style="width:100%;margin-top:6px">To√†n m√†n h√¨nh</button>
      <label style="display:block;margin-top:8px">M√†u ch·ªß ƒë·∫°o</label>
      <input id="colorPick" type="color" value="#6366f1" style="width:100%">

      <div style="height:1px;background:#e2e8f0;margin:10px 0"></div>
      <div style="font-weight:800;margin-bottom:6px">ƒê·ªìng h·ªì b·∫•m gi·ªù</div>
      <label class="switch"><input id="timerEnable" type="checkbox" checked> B·∫≠t ƒë·∫øm ng∆∞·ª£c</label>
      <input id="timerMinutes" type="number" min="1" value="15" placeholder="Ph√∫t" />
    </div>

    <!-- SETUP -->
    <div id="setup" class="screen">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="viewBtn" class="btn" type="button">ƒê·ªÅ hi·ªán t·∫°i</button>
        <button id="modeBtn" class="btn secondary" type="button">Nh·∫≠p nhanh</button>
        <span id="count" style="align-self:center;color:var(--muted);font-weight:700"></span>
      </div>

      <div id="manual" style="margin-top:12px">
        <label>Lo·∫°i c√¢u h·ªèi</label>
        <select id="qType">
          <option value="mcq">Tr·∫Øc nghi·ªám 4 ƒë√°p √°n</option>
          <option value="essay">T·ª± lu·∫≠n</option>
        </select>

        <!-- MCQ fields -->
        <div id="mcqFields">
          <input id="qInp" placeholder="C√¢u h·ªèi">
          <input id="a0" placeholder="ƒê√°p √°n A"><input id="a1" placeholder="ƒê√°p √°n B">
          <input id="a2" placeholder="ƒê√°p √°n C"><input id="a3" placeholder="ƒê√°p √°n D">
          <label>ƒê√°p √°n ƒë√∫ng</label>
          <select id="correctSel"></select>
          <input id="imgInp" type="file" accept="image/*">
          <img id="imgPreview" class="hidden"/>
          <button id="clearImg" class="remove-img hidden" type="button">X√≥a ·∫£nh</button>
        </div>

        <!-- ESSAY fields -->
        <div id="essayFields" class="hidden">
          <textarea id="essayQ" placeholder="C√¢u h·ªèi t·ª± lu·∫≠n"></textarea>
          <textarea id="essayModel" placeholder="ƒê√°p √°n m·∫´u (ƒë·ªÉ g·ª£i √Ω v√† so kh·ªõp th√¥ng minh)"></textarea>
          <input id="essayKeywords" placeholder="T·ª´ kho√° b·∫Øt bu·ªôc (ph√¢n t√°ch b·∫±ng d·∫•u ph·∫©y)">
          <div style="display:flex;gap:10px;align-items:center">
            <input id="essayPoints" type="number" min="1" value="10" style="max-width:120px" placeholder="Thang ƒëi·ªÉm">
            <span style="color:var(--muted)">m·∫∑c ƒë·ªãnh 10 ƒëi·ªÉm</span>
          </div>
        </div>
        <button id="addBtn" class="btn" style="margin-top:8px" type="button">Th√™m c√¢u h·ªèi</button>
      </div>

      <!-- BULK IMPORT -->
      <div id="bulk" class="hidden" style="margin-top:12px">
        <textarea id="bulkArea" rows="6" placeholder="D√°n ƒë·ªãnh d·∫°ng nhanh‚Ä¶
V√≠ d·ª•:
C√¢u 1: 2+2=?
*A. 4
B. 5
C. 3
D. 6"></textarea>
        <button id="importBtn" class="btn" style="margin-top:6px" type="button">Import nhanh</button>
      </div>
    </div>

    <!-- VIEW -->
    <div id="view" class="screen hidden">
      <h2 style="margin:0 0 8px">ƒê·ªÅ hi·ªán t·∫°i</h2>
      <div id="viewList"></div>
      <div id="clearAllWrap"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="backSetup" class="btn secondary" type="button">Quay l·∫°i ch·ªânh ƒë·ªÅ</button>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="quiz" class="screen hidden">
      <div class="topbar">
        <div class="progress"><span id="progbar"></span></div>
        <div class="timer" id="timerTxt">00:00</div>
        <div class="chip" id="levelChip">Lv 1 ‚Ä¢ 0%</div>
      </div>
      <div id="quizList"></div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="submitBtn" class="btn" type="button">N·ªôp b√†i</button>
      </div>
    </div>

    <!-- RESULT -->
    <div id="result" class="screen hidden">
      <div class="qcard">
        <h3>K·∫øt qu·∫£</h3>
        <p id="resultTxt" style="font-size:1.15rem;font-weight:800;margin:0"></p>
        <div id="xpTxt" style="margin-top:6px;color:var(--muted)"></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="retryBtn" class="btn" type="button">L√†m l·∫°i</button>
        <button id="homeBtn" class="btn secondary" type="button">Trang ch·ªß</button>
        <button id="viewAnswerBtn" class="btn ghost" type="button">Xem ƒë√°p √°n</button>
      </div>
    </div>

    <!-- ANSWER REVIEW -->
    <div id="answerReview" class="screen hidden">
      <h2>ƒê√°p √°n chi ti·∫øt</h2>
      <div id="answerList"></div>
      <button id="backResultBtn" class="btn secondary" style="margin-top:10px" type="button">Quay l·∫°i k·∫øt qu·∫£</button>
    </div>

  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  let qs=[],score=0,shuffleQ=true,shuffleA=true,spell=true, editIndex=null;
  const LS_KEY = 'quizapp-qs-v4';
  const PROFILE_KEY='quizapp-profile-v1';

  // ===== Level / XP helpers =====
  function levelFromXP(xp){
    // simple curve: level n threshold ~ n*(n+1)*100/2 => 100, 300, 600, 1000, ...
    let lvl=1, need=100, spent=0;
    while(xp >= need){
      xp -= need; spent += need;
      lvl++; need = 100*lvl; // growing requirement
    }
    const cur=xp, next=need; const pct = Math.round(cur*100/next);
    return {level:lvl, cur, next, pct, totalSpent:spent};
  }
  function loadProfile(){
    try{ const p=JSON.parse(localStorage.getItem(PROFILE_KEY)); return p||{name:'', xp:0}; }catch{return {name:'',xp:0};}
  }
  function saveProfile(p){ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }

  // ===== Diacritics-safe text utils =====
  const DIAC = {
    '√°':'a','√†':'a','·∫£':'a','√£':'a','·∫°':'a','ƒÉ':'a','·∫Ø':'a','·∫±':'a','·∫≥':'a','·∫µ':'a','·∫∑':'a','√¢':'a','·∫•':'a','·∫ß':'a','·∫©':'a','·∫´':'a','·∫≠':'a',
    'ƒë':'d','√©':'e','√®':'e','·∫ª':'e','·∫Ω':'e','·∫π':'e','√™':'e','·∫ø':'e','·ªÅ':'e','·ªÉ':'e','·ªÖ':'e','·ªá':'e',
    '√≠':'i','√¨':'i','·ªâ':'i','ƒ©':'i','·ªã':'i',
    '√≥':'o','√≤':'o','·ªè':'o','√µ':'o','·ªç':'o','√¥':'o','·ªë':'o','·ªì':'o','·ªï':'o','·ªó':'o','·ªô':'o','∆°':'o','·ªõ':'o','·ªù':'o','·ªü':'o','·ª°':'o','·ª£':'o',
    '√∫':'u','√π':'u','·ªß':'u','≈©':'u','·ª•':'u','∆∞':'u','·ª©':'u','·ª´':'u','·ª≠':'u','·ªØ':'u','·ª±':'u',
    '√Ω':'y','·ª≥':'y','·ª∑':'y','·ªπ':'y','·ªµ':'y'
  };
  function undiac(s){ return (s||'').toLowerCase().split('').map(ch=>DIAC[ch]||ch).join(''); }
  const normalize = s => undiac(s).replace(/[^a-z0-9\\s]/g,' ').replace(/\\s+/g,' ').trim();
  const tokenize = s => normalize(s).split(' ').filter(Boolean);
  function jaccard(a,b){ const A=new Set(a),B=new Set(b); const inter=[...A].filter(x=>B.has(x)).length; const union=A.size+B.size-inter; return union? inter/union:0; }

  // lightweight synonyms
  const SYN = { "nguyen nhan":["ly do","do dau"], "giai phap":["cach khac phuc","cach giai quyet","solution"], "uu diem":["diem manh","loi the"], "nhuoc diem":["han che","bat loi"] };
  function expandKeywords(keys){ const out=new Set(); (keys||[]).forEach(k=>{ const nk=normalize(k); out.add(nk); (SYN[nk]||[]).forEach(x=>out.add(normalize(x))); }); return [...out]; }

  // ===== State for timer =====
  let timerOn=true, timerMin=15, timerRemainSec=0, timerId=null;

  function fmtTime(sec){ const m=Math.floor(sec/60), s=sec%60; return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); }
  function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }
  function startTimer(){
    stopTimer();
    if(!timerOn){ $('timerTxt').textContent='--:--'; return; }
    timerRemainSec = Math.max(1, timerMin*60|0);
    $('timerTxt').textContent = fmtTime(timerRemainSec);
    timerId = setInterval(()=>{
      timerRemainSec--;
      $('timerTxt').textContent = fmtTime(Math.max(0,timerRemainSec));
      if(timerRemainSec<=0){ stopTimer(); trySubmit(); }
    }, 1000);
  }

  // ===== Fullscreen helpers =====
  function toggleFullscreen(){
    const el = document.documentElement; // full page
    if (!document.fullscreenElement &&
        !document.webkitFullscreenElement &&
        !document.mozFullScreenElement &&
        !document.msFullscreenElement) {
      (el.requestFullscreen ||
       el.webkitRequestFullscreen ||
       el.mozRequestFullScreen ||
       el.msRequestFullscreen).call(el);
    } else {
      (document.exitFullscreen ||
       document.webkitExitFullscreen ||
       document.mozCancelFullScreen ||
       document.msExitFullscreen).call(document);
    }
  }
  function syncFsLabel(){
    const on = !!(document.fullscreenElement || document.webkitFullscreenElement ||
                  document.mozFullScreenElement || document.msFullscreenElement);
    if ($('fsBtn')) $('fsBtn').textContent = on ? 'Tho√°t to√†n m√†n h√¨nh' : 'To√†n m√†n h√¨nh';
  }
  ['fullscreenchange','webkitfullscreenchange','mozfullscreenchange','MSFullscreenChange']
    .forEach(ev => document.addEventListener(ev, syncFsLabel));

  // ===== General helpers =====
  function saveToStorage(){ localStorage.setItem(LS_KEY, JSON.stringify(qs)); }
  function loadFromStorage(){ try{ const data=JSON.parse(localStorage.getItem(LS_KEY)); if(Array.isArray(data)) qs=data; }catch{} }
  function updateCount(){ $('count').textContent=`${qs.length} c√¢u h·ªèi`; }
  function resetMCQ(){ $('qInp').value=''; ['a0','a1','a2','a3'].forEach(id=>$(id).value=''); $('correctSel').value=0; $('imgInp').value=''; $('imgPreview').classList.add('hidden'); $('clearImg').classList.add('hidden'); }
  function resetEssay(){ ['essayQ','essayModel','essayKeywords'].forEach(id=>$(id).value=''); $('essayPoints').value=10; }
  function resetManual(){ resetMCQ(); resetEssay(); editIndex=null; }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
  function show(k){ ['setup','view','quiz','result','answerReview'].forEach(id=>$(id).classList.add('hidden')); $(k).classList.remove('hidden'); }

  // ===== INIT =====
  document.addEventListener('DOMContentLoaded', function(){
    loadFromStorage(); updateCount();
    // init correct options
    for(let i=0;i<4;i++){ const o=document.createElement('option'); o.value=i; o.textContent=String.fromCharCode(65+i); $('correctSel').appendChild(o); }
    // profile
    const prof=loadProfile();
    if(prof.name){ $('nameInp').value=prof.name; }
    updateLevelChip(prof.xp);
    // initial FS label
    syncFsLabel();
  });

  // ===== Settings toggle =====
  $('gear').onclick=function(e){ e.stopPropagation(); $('settings').classList.toggle('hidden'); };
  document.addEventListener('click',(e)=>{ if(!$('settings').contains(e.target) && e.target!==$('gear')) $('settings').classList.add('hidden'); });
  $('colorPick').oninput=(e)=> document.documentElement.style.setProperty('--primary',e.target.value);
  $('toggleSQ').onclick=function(){ shuffleQ=!shuffleQ; this.textContent=`X√°o c√¢u h·ªèi: ${shuffleQ?'B·∫≠t':'T·∫Øt'}`; };
  $('toggleSA').onclick=function(){ shuffleA=!shuffleA; this.textContent=`X√°o ƒë√°p √°n: ${shuffleA?'B·∫≠t':'T·∫Øt'}`; };
  $('toggleSpell').onclick=function(){ spell=!spell; this.textContent=`Spellcheck: ${spell?'B·∫≠t':'T·∫Øt'}`; };
  $('timerEnable').onchange=function(){ timerOn=this.checked; };
  $('timerMinutes').oninput=function(){ const v=+this.value||15; timerMin=Math.max(1, v); };
  $('fsBtn').onclick = toggleFullscreen;

  // ===== Tips & Login =====
  $('tipsBtn').onclick=()=> $('tips').classList.add('show');
  $('closeTips').onclick=()=> $('tips').classList.remove('show');
  $('userBtn').onclick=()=> $('login').classList.add('show');
  $('closeLogin').onclick=()=> $('login').classList.remove('show');

  $('startBtn').onclick=function(){
    const name = $('nameInp').value.trim();
    if(!name) return alert('Nh·∫≠p t√™n');
    // save name
    const p=loadProfile(); p.name=name; saveProfile(p);
    $('login').classList.remove('show');
    if(!qs.length) return alert('H√£y nh·∫≠p c√¢u h·ªèi tr∆∞·ªõc!');
    if(shuffleQ) shuffle(qs);
    if(shuffleA) qs.forEach(q=>{ if(q.type==='mcq'){ const p=q.options.map((o,i)=>({o,i})); shuffle(p); q.options=p.map(x=>x.o); q.correct=p.findIndex(x=>x.i===q.correct); }});
    renderQuiz(); show('quiz'); startTimer();
  };

  // ===== Mode & type switch =====
  $('modeBtn').onclick=function(){ const m=$('manual').classList.toggle('hidden'); $('bulk').classList.toggle('hidden'); this.textContent=m?'Nh·∫≠p nhanh':'Nh·∫≠p th·ªß c√¥ng'; };
  $('qType').onchange=function(){ const t=this.value; $('mcqFields').classList.toggle('hidden', t!=='mcq'); $('essayFields').classList.toggle('hidden', t!=='essay'); };

  // ===== Image preview =====
  $('imgInp').onchange = function(e){ const file=e.target.files[0]; if(file){ const url=URL.createObjectURL(file); $('imgPreview').src=url; $('imgPreview').classList.remove('hidden'); $('clearImg').classList.remove('hidden'); }};
  $('clearImg').onclick = function(){ $('imgInp').value=''; $('imgPreview').src=''; $('imgPreview').classList.add('hidden'); $('clearImg').classList.add('hidden'); };

  // ===== Add question =====
  $('addBtn').onclick=function(){
    const type=$('qType').value;
    if(type==='mcq'){
      const qText=$('qInp').value.trim();
      const opts=['a0','a1','a2','a3'].map(id=>$(id).value.trim());
      const ci=+$('correctSel').value;
      if(!qText||opts.some(o=>!o)) return alert('Thi·∫øu d·ªØ li·ªáu tr·∫Øc nghi·ªám');
      const imgSrc=$('imgPreview').src||null;
      const item={type:'mcq',question:qText,options:opts,correct:ci,image:imgSrc};
      if(editIndex!=null){ qs[editIndex]=item; editIndex=null; } else qs.push(item);
      resetMCQ();
    } else {
      const q=$('essayQ').value.trim();
      const model=$('essayModel').value.trim();
      const kwRaw=$('essayKeywords').value.trim();
      const points=Math.max(1, +$('essayPoints').value||10);
      if(!q) return alert('Thi·∫øu c√¢u h·ªèi t·ª± lu·∫≠n');
      const keywords = kwRaw ? kwRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
      const item={type:'essay',question:q,modelAnswer:model,keywords,points};
      if(editIndex!=null){ qs[editIndex]=item; editIndex=null; } else qs.push(item);
      resetEssay();
    }
    saveToStorage(); updateCount();
  };

  // ===== Bulk import (MCQ) =====
  $('importBtn').onclick=function(){
    qs=[]; const blocks=$('bulkArea').value.trim().split(/\\n\\s*\\n/);
    const optRx=/^\\s*(\\*)?\\s*([A-D])\\s*[\\.:\\/\\)\\-]?\\s*(.+)$/i;
    blocks.forEach(b=>{
      const lines=b.split('\\n').map(l=>l.trim()).filter(Boolean);
      if(lines.length<2) return;
      const question=lines[0].replace(/^(?:-?\\s*)?(?:C√¢u)?\\s*\\d+\\s*[:\\.:\\/\\)\\-]?\\s*/i,'').trim();
      const opts=new Array(4); let correct=0;
      lines.slice(1).forEach(line=>{ const m=line.match(optRx); if(!m) return; const idx=m[2].toUpperCase().charCodeAt(0)-65; opts[idx]=m[3].trim(); if(m[1]) correct=idx; });
      if(opts.filter(Boolean).length===4) qs.push({type:'mcq',question,options:opts,correct,image:null});
    });
    saveToStorage(); $('bulkArea').value=''; updateCount();
  };

  // ===== View list =====
  $('viewBtn').onclick=function(){ renderView(); show('view'); };
  $('backSetup').onclick=function(){ show('setup'); };

  function renderView(){
    const list=$('viewList'); list.innerHTML='';
    qs.forEach((q,i)=>{
      const card=document.createElement('div'); card.className='qcard';
      let html = `<h3>C√¢u ${i+1} (${q.type==='essay'?'T·ª± lu·∫≠n':'Tr·∫Øc nghi·ªám'})</h3>`;
      html += `<div style="color:var(--muted);margin-bottom:6px">${q.type==='essay'?'Thang ƒëi·ªÉm: '+q.points:''}</div>`;
      html += `<div>${q.question}</div>`;
      if(q.type==='mcq' && q.image) html+=`<img src="${q.image}" style="max-width:100%;margin:12px 0;border-radius:12px">`;
      if(q.type==='mcq') html+=`<ul style="margin:8px 0 0 18px;color:var(--muted)">${q.options.map((o,j)=>`<li${j===q.correct?" style='font-weight:700;color:#16a34a'":''}>${String.fromCharCode(65+j)}. ${o}</li>`).join('')}</ul>`;
      if(q.type==='essay' && q.keywords?.length) html+=`<div style="margin-top:8px;color:var(--muted)"><strong>T·ª´ kho√°:</strong> ${q.keywords.join(', ')}</div>`;
      card.innerHTML=html;
      const act=document.createElement('div'); act.className='actions';
      const e=document.createElement('span'); e.textContent='‚úé'; e.title='S·ª≠a'; e.onclick=function(){
        show('setup'); if($('bulk').classList.contains('hidden')===false) $('modeBtn').click();
        $('qType').value=q.type; $('qType').dispatchEvent(new Event('change'));
        if(q.type==='mcq'){
          $('qInp').value=q.question; q.options.forEach((opt,j)=>$('a'+j).value=opt);
          $('correctSel').value=q.correct; if(q.image){ $('imgPreview').src=q.image; $('imgPreview').classList.remove('hidden'); $('clearImg').classList.remove('hidden'); }
        } else {
          $('essayQ').value=q.question; $('essayModel').value=q.modelAnswer||''; $('essayKeywords').value=(q.keywords||[]).join(', '); $('essayPoints').value=q.points||10;
        }
        editIndex=i; qs.splice(i,1); saveToStorage(); updateCount();
      };
      const d=document.createElement('span'); d.textContent='‚úñ'; d.title='Xo√°'; d.onclick=function(){ if(confirm('Xo√° c√¢u n√†y?')){ qs.splice(i,1); saveToStorage(); renderView(); updateCount(); } };
      act.append(e,d); card.appendChild(act); list.appendChild(card);
    });
    const wrap=$('clearAllWrap'); wrap.innerHTML='';
    if(qs.length){
      const clearBtn=document.createElement('button'); clearBtn.type='button'; clearBtn.textContent='Xo√° t·∫•t c·∫£'; clearBtn.className='btn secondary'; clearBtn.style.background='#fee2e2'; clearBtn.style.color='#b91c1c';
      clearBtn.onclick=function(){ if(confirm('Xo√° to√†n b·ªô ƒë·ªÅ?')){ qs=[]; localStorage.removeItem(LS_KEY); renderView(); updateCount(); } };
      wrap.appendChild(clearBtn);
    }
  }

  // ===== Quiz render =====
  function updateLevelChip(xp){
    const {level,pct} = levelFromXP(xp);
    $('levelChip').textContent = `Lv ${level} ‚Ä¢ ${pct}%`;
  }

  function renderQuiz(){
    const list=$('quizList'); list.innerHTML=''; score=0; $('progbar').style.width='0%';
    const prof=loadProfile(); updateLevelChip(prof.xp);
    qs.forEach((q,i)=>{
      const card=document.createElement('div'); card.className='qcard';
      let html=`<h3>C√¢u ${i+1}: ${q.question}</h3>`;
      if(q.type==='mcq'){
        if(q.image) html+=`<img src="${q.image}" style="max-width:100%;margin:12px 0;border-radius:12px">`;
        card.innerHTML=html;
        const wrap=document.createElement('div'); wrap.className='optwrap';
        q.options.forEach((o,j)=>{
          const op=document.createElement('div'); op.className='opt'; op.textContent=`${String.fromCharCode(65+j)}. ${o}`;
          op.onclick=function(){wrap.querySelectorAll('.opt').forEach(x=>x.classList.remove('selected'));op.classList.add('selected'); updateProgress();};
          wrap.appendChild(op);
        });
        card.appendChild(wrap);
      } else {
        card.innerHTML=html;
        const ta=document.createElement('textarea'); ta.placeholder='Nh·∫≠p c√¢u tr·∫£ l·ªùi t·ª± lu·∫≠n...'; ta.spellcheck=spell; ta.oninput=updateProgress; card.appendChild(ta);
      }
      list.appendChild(card);
    });
  }

  function updateProgress(){
    const cards=[...document.querySelectorAll('#quizList .qcard')];
    let answered=0; cards.forEach(c=>{ const mc=c.querySelector('.opt.selected'); const ta=c.querySelector('textarea'); if(mc || (ta && ta.value.trim())) answered++; });
    const pct = cards.length? Math.round(answered*100/cards.length) : 0; $('progbar').style.width=pct+'%';
  }

  function trySubmit(){ if(!$('result').classList.contains('hidden')) return; $('submitBtn').click(); }

  // ===== Submit =====
  $('submitBtn').onclick=function(){
    stopTimer();
    const userAnswers=[];
    document.querySelectorAll('#quizList .qcard').forEach((card,i)=>{
      const ta=card.querySelector('textarea');
      if(ta){ userAnswers.push({type:'essay', text:ta.value}); }
      else{ const sel=card.querySelector('.opt.selected'); const idx= sel? sel.textContent.charCodeAt(0)-65 : null; userAnswers.push({type:'mcq', idx}); }
    });

    // scoring
    let totalPoints=0; let totalEarned=0; let mcqCorrect=0; const details=[];
    userAnswers.forEach((ans,i)=>{
      const q=qs[i];
      if(q.type==='mcq'){
        totalPoints+=1; const correct= ans.idx===q.correct; if(correct){ totalEarned+=1; mcqCorrect++; }
        details.push({type:'mcq',correct, your:ans.idx, correctIdx:q.correct, options:q.options});
      } else {
        const points=q.points||10; totalPoints+=points; const text=(ans.text||'').trim();
        const kw = expandKeywords(q.keywords||[]);
        const toks=tokenize(text); const modelToks=tokenize(q.modelAnswer||'');
        const present=[]; const missing=[];
        kw.forEach(k=>{ const hit = toks.join(' ').includes(k) || toks.some(w=>w===k); (hit?present:missing).push(k); });
        const kwCoverage = kw.length? present.length/kw.length : 0;
        const sim = modelToks.length? jaccard(toks, modelToks) : 0;
        const wKw=0.7, wSim=0.3; const raw= wKw*kwCoverage + wSim*sim; const earned = Math.round(raw*points*10)/10; totalEarned+=earned;
        details.push({type:'essay', earned, points, text, model:q.modelAnswer||'', present, missing, kwCoverage, sim});
      }
    });

    // Decorate UI for MCQ & essay
    document.querySelectorAll('#quizList .qcard').forEach((card,i)=>{
      const q=qs[i]; const d=details[i];
      if(q.type==='mcq'){
        const opts=card.querySelectorAll('.opt');
        opts.forEach((opt,j)=>{
          opt.onclick=null; opt.classList.remove('correct','wrong');
          if(j===q.correct) opt.classList.add('correct');
          if(d.your===j && j!==q.correct) opt.classList.add('wrong');
        });
      } else {
        const ta=card.querySelector('textarea'); if(!ta) return;
        ta.readOnly=true; ta.style.borderColor = d.earned>=(q.points*0.6)? '#16a34a' : '#ef4444'; ta.classList.add(d.earned>=(q.points*0.6)?'correct':'wrong');
        const fb=document.createElement('div'); fb.style.marginTop='8px'; fb.style.color='var(--muted)';
        fb.innerHTML=`<strong>ƒêi·ªÉm t·∫°m t√≠nh:</strong> ${d.earned}/${d.points} ¬∑ <strong>T·ª´ kho√°</strong>: ‚úÖ ${d.present.length}${d.missing.length?` ¬∑ ‚ùå ${d.missing.length}`:''} ¬∑ <strong>T∆∞∆°ng ƒë·ªìng</strong>: ${(d.sim*100).toFixed(0)}%`;
        card.appendChild(fb);
      }
    });

    const name=$('nameInp').value||'B·∫°n';
    const totalRounded = Math.round(totalEarned*100)/100;
    $('resultTxt').innerHTML = `${name}, b·∫°n ƒë·∫°t <strong>${totalRounded}/${totalPoints}</strong> ƒëi·ªÉm.`;

    // XP calc: base on percent + mcq bonus
    const percent = totalPoints? totalEarned/totalPoints : 0;
    const xpGain = Math.round(100*percent + mcqCorrect*2);
    const prof=loadProfile(); const newXP = (prof.xp||0) + xpGain; saveProfile({...prof, xp:newXP});
    const lvlInfo = levelFromXP(newXP);
    $('xpTxt').textContent = `B·∫°n nh·∫≠n +${xpGain} XP ‚Ä¢ C·∫•p hi·ªán t·∫°i: Lv ${lvlInfo.level} (${lvlInfo.pct}%)`;
    updateLevelChip(newXP);

    // Build review
    const answerHTML = details.map((d,i)=>{
      if(d.type==='mcq'){
        const your = d.your!=null? `${String.fromCharCode(65+d.your)}. ${d.options[d.your]}` : 'Kh√¥ng ch·ªçn';
        const corr = `${String.fromCharCode(65+d.correctIdx)}. ${d.options[d.correctIdx]}`;
        return `<div class="qcard"><h3>C√¢u ${i+1} (Tr·∫Øc nghi·ªám)</h3><p><strong>B·∫°n:</strong> ${your} ‚Üí <strong>ƒê√∫ng:</strong> ${corr}</p></div>`;
      } else {
        const mk = `<div style='margin-top:6px'><strong>ƒêi·ªÉm:</strong> ${d.earned}/${d.points} ¬∑ <strong>T·ª´ kho√° ƒë·∫°t:</strong> ${d.present.join(', ')||'‚Äî'}${d.missing.length?` ¬∑ <strong>C√≤n thi·∫øu:</strong> ${d.missing.join(', ')}`:''} ¬∑ <strong>T∆∞∆°ng ƒë·ªìng:</strong> ${(d.sim*100).toFixed(0)}%</div>`;
        const modelBlock = d.model? `<details style='margin-top:8px'><summary style='cursor:pointer'>Xem ƒë√°p √°n m·∫´u</summary><div style='margin-top:6px;white-space:pre-wrap;background:#f8fafc;padding:10px;border-radius:12px'>${d.model}</div></details>` : '';
        return `<div class="qcard"><h3>C√¢u ${i+1} (T·ª± lu·∫≠n)</h3><div style='white-space:pre-wrap'>${d.text || '<i>(Kh√¥ng tr·∫£ l·ªùi)</i>'}</div>${mk}${modelBlock}</div>`;
      }
    }).join('');
    $('answerList').innerHTML=answerHTML;

    show('result');
  };

  $('retryBtn').onclick=function(){ renderQuiz(); show('quiz'); startTimer(); };
  $('homeBtn').onclick=function(){ qs=[]; score=0; ['nameInp'].forEach(id=>$(id).value=''); updateCount(); resetManual(); show('setup'); saveToStorage(); stopTimer(); };
  $('viewAnswerBtn').onclick=function(){ show('answerReview'); };
  $('backResultBtn').onclick=function(){ show('result'); };

  // ===== Quiz builder end =====
})();
</script>
</body>
</html>
